{% extends 'base.html' %}

{% block title %}Annonces - Annonce Platform{% endblock %}

{% block content %}
    <div class="annonces-header">
        <h1>Toutes les Annonces</h1>
        {% if current_user.is_authenticated %}
            <a href="{{ url_for('add') }}" class="btn">Poster une annonce</a>
        {% endif %}
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <ul class="annonces">
        {% for annonce in annonces %}
            <li>
                {% if annonce.image_filename %}
                    <img src="{{ url_for('uploaded_file', filename=annonce.image_filename) }}" alt="{{ annonce.title }}">
                {% endif %}
                <h2>{{ annonce.title }}</h2>
                <p class="price">{{ "%.2f"|format(annonce.price) }} MAD</p>
                <p>{{ annonce.description|truncate(100) }}</p>
                <p class="author-info"><em>Vendu par : {{ annonce.author.email }}</em></p>
                
                <div class="annonce-interactions">
                    <!-- Likes -->
                    <div class="likes-section">
                        <span>{{ annonce.likes|length }} Likes</span>
                        {% if current_user.is_authenticated %}
                            <form action="{{ url_for('like_annonce', annonce_id=annonce.id) }}" method="post" style="display: inline;">
                                {% set user_liked = false %}
                                {% for like in annonce.likes %}
                                    {% if like.user_id == current_user.id %}
                                        {% set user_liked = true %}
                                    {% endif %}
                                {% endfor %}
                                <button type="submit" class="heart-btn {% if user_liked %}liked{% endif %}">
                                    &hearts;
                                </button>
                            </form>
                        {% endif %}
                    </div>

                    <!-- Comments -->
                    <div class="comments-section">
                        <h3>Comments</h3>
                        {% for comment in annonce.comments %}
                            <div class="comment">
                                <p><strong>{{ comment.author.email }}:</strong> {{ comment.text }}</p>
                            </div>
                        {% endfor %}
                        
                        {% if current_user.is_authenticated %}
                            <form action="{{ url_for('add_comment', annonce_id=annonce.id) }}" method="post">
                                {{ comment_form.hidden_tag() }}
                                <div class="form-group">
                                    {{ comment_form.text(class="form-control", rows="2") }}
                                </div>
                                <div class="form-group">
                                    {{ comment_form.submit(class="btn") }}
                                </div>
                            </form>
                        {% endif %}
                    </div>
                </div>

                {% if current_user.is_authenticated and (current_user.id == annonce.user_id or current_user.is_admin) %}
                    <div class="annonce-actions">
                        <form action="{{ url_for('delete_annonce', annonce_id=annonce.id) }}" method="post" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette annonce ?');">
                            <button type="submit" class="btn-danger">Supprimer</button>
                        </form>
                    </div>
                {% endif %}
            </li>
        {% else %}
            <p>Il n'y a aucune annonce pour le moment.</p>
        {% endfor %}
    </ul>
{% endblock %}